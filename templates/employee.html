<!DOCTYPE html>
<html>
<head>
  <title>Employee Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
<h2>Welcome Employee #{{ employee_id }}</h2>

  <div id="map"></div>

  <div class="form-container">
    <div id="newCustomerForm">
      <h3>New Customer</h3>
      <input id="customerName" type="text" placeholder="Customer Name" required>
      <input id="customerPhone" type="text" placeholder="Phone Number" required>
      <input id="bottleCount" type="number" placeholder="Bottle count" min="0" required>
      <button id="saveNew">Save New Customer</button>
    </div>

    <div id="existingCustomerForm" style="display:none;">
      <h3>Existing Customer</h3>
      <p><b>Name:</b> <span id="exName"></span></p>
      <p><b>Phone:</b> <span id="exPhone"></span></p>
      <p><b>Previous Bottles:</b> <span id="exPrev"></span></p>
      <input id="returnedCount" type="number" placeholder="Returned bottles" min="0">
      <input id="borrowedCount" type="number" placeholder="New bottles taken" min="0">
      <button id="saveUpdate">Update Bottles</button>
    </div>

    <a href="/logout">Logout</a>
  </div>
<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
    font-family: "Segoe UI", Arial, sans-serif;
    display: flex;
    flex-direction: column;
    background-color: #f5f6fa;
  }

  /* Header */
  h2 {
    text-align: center;
    margin: 10px 0;
    font-size: 1.4rem;
  }

  /* ‚úÖ The map takes 3/5 of the screen height */
  #map {
    width: 100%;
    height: 60vh; /* 3/5 of the screen */
    flex: 3;
    border-radius: 0;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }

  /* ‚úÖ Forms container takes 2/5 of screen height */
  .form-container {
    flex: 2;
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    overflow-y: auto;
    padding: 15px;
    box-sizing: border-box;
  }

  /* Individual forms */
  #newCustomerForm, #existingCustomerForm {
    width: 90%;
    height: 40vh;
    background: #fff;
    border-radius: 15px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    padding: 20px;
    margin-bottom: 15px;
  }

  h3 {
    margin-top: 0;
    text-align: center;
  }

  input, button {
    width: 100%;
    height:5vh;
    padding: 12px;
    margin: 8px 0;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 16px;
    box-sizing: border-box;
  }

  button {
    background-color: #007bff;
    color: white;
    border: none;
    cursor: pointer;
    font-weight: 500;
    transition: background 0.3s;
  }

  button:hover {
    background-color: #0056b3;
  }

  /* Logout link */
  a {
    text-align: center;
    display: block;
    margin-top: 10px;
    color: #007bff;
    text-decoration: none;
  }

  a:hover {
    text-decoration: underline;
  }

  /* ‚úÖ Responsive for mobile */
  @media (max-width: 600px) {
    #map {
      height: 60vh;
    }

    .form-container {
      height: 40vh;
      padding: 10px;
    }


    
  }
</style>
<script>
(async () => {
  try {
    // Get current location
    const pos = await new Promise((resolve, reject) => {
      navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true });
    });
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    const radius = 5;
    // Setup map
    const map = L.map('map').setView([lat, lon], 17);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 22 }).addTo(map);

    // Red "You are here" marker
    const currentIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/252/252025.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [0, -41]
    });

    L.marker([lat, lon], { icon: currentIcon })
      .addTo(map)
      .bindPopup("üìç You are here")
      .on('click', () => {
        document.getElementById('newCustomerForm').style.display = 'block';
        document.getElementById('existingCustomerForm').style.display = 'none';
      })
      .openPopup();

    // Load assigned customers
    const res = await fetch(`/get_employee_markers?lat=${lat}&lon=${lon}`)
    const data = await res.json();

    if (data.status === "success") {
      const customers = data.data;

      const customerIcon = L.divIcon({
        className: 'custom-customer-marker',
        html: '<span style="font-size: 30px;">üìç</span>',
        iconSize: [10,30],
        iconAnchor: [10, 30]
      });

      customers.forEach(c => {
        if (c.latitude && c.longitude) {
          L.marker([c.latitude, c.longitude], { icon: customerIcon })
            .addTo(map)
            .bindPopup(`üß¥ <b>${c.customer_name}</b><br>üíß ${c.customer_bottles} bottles<br>üìû ${c.customer_phone}`)
            .on('click', () => {
              document.getElementById('newCustomerForm').style.display = 'none';
              document.getElementById('existingCustomerForm').style.display = 'block';
              document.getElementById('exName').textContent = c.customer_name;
              document.getElementById('exPhone').textContent = c.customer_phone;
              document.getElementById('exPrev').textContent = c.customer_bottles;
              document.getElementById('saveUpdate').setAttribute('data-id', c.customer_id);
            });
        }
      });
    }

    // Save new customer
    document.getElementById('saveNew').onclick = async () => {
      const name = document.getElementById('customerName').value;
      const phone = document.getElementById('customerPhone').value;
      const count = document.getElementById('bottleCount').value;

      if (!name || !phone || !count) return alert('Please fill all fields.');

      const res = await fetch('/update_location', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type: 'new', lat, lon, name, phone, count })
      });

      const data = await res.json();
      if (data.status === 'success') {
        alert('‚úÖ New customer saved!');
        location.reload();
      } else alert('‚ùå Error: ' + data.message);
    };
  

    document.getElementById('saveUpdate').onclick = async (e) => {
    const id = e.target.getAttribute('data-id');
    const returned = parseInt(document.getElementById('returnedCount').value || 0);
    const borrowed = parseInt(document.getElementById('borrowedCount').value || 0);

    if (isNaN(returned) || isNaN(borrowed)) {
      return alert('Enter valid numbers for returned and borrowed bottles.');
    }

    const res = await fetch('/update_location', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        type: 'existing',
        customer_id: id,
        returned_bottles: returned,
        borrowed_bottles: borrowed
      })
    });

       const data = await res.json();
  if (data.status === 'success') {
    alert('‚úÖ Bottles updated successfully!');
    location.reload();
  } else alert('‚ùå Error: ' + data.message);
};

  } catch (err) {
    alert("Could not get location: " + err);
  }
  
})();
</script>
</body>
</html>