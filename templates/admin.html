<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard</title>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background-color: #f6f9fc;
      color: #333;
    }
    h3{
      text-align: center;
    }

    header {
      text-align: center;
      background: #007bff;
      color: white;
      padding: 15px;
      font-size: 1.5rem;
    }

    .container {
      display: flex;
      flex-direction: column;
      gap: 25px;
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }

    #map {
      height: 500px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      width: 90%;
      margin: auto;
    }

    section {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    h3 {
      color: #007bff;
      margin-bottom: 15px;
    }

    input, button {
      padding: 10px;
      margin: 5px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1rem;
      width: 100%;
      box-sizing: border-box;
    }

    button {
      background-color: #007bff;
      color: white;
      cursor: pointer;
      border: none;
      transition: background-color 0.25s;
    }

    button:hover {
      background-color: #0056b3;
    }

    a {
      color: #007bff;
      text-decoration: none;
      font-weight: bold;
      text-align: center;
      display: block;
      margin-top: 15px;
    }

    a:hover {
      text-decoration: underline;
    }

    /* Responsive Design */
    @media (max-width: 600px) {
      .container {
        padding: 10px;
      }
      section {
        padding: 15px;
      }
    }
  </style>
</head>

<body>
  <header>Admin Dashboard</header>

  
    <!-- üåç Map Section -->
    
      <h3>Employee Bottle Locations</h3>
      <div id="map"></div>
    
  <div class="container">
    <!-- ‚ûï Add Employee -->
    <section>
      <h3>Add New Employee</h3>
      <form id="addEmployeeForm">
        <input type="text" name="name" placeholder="Employee Name" required>
        <input type="password" name="password" placeholder="Password" required>
        <button type="submit">Add Employee</button>
      </form>
      <p id="addEmployeeMsg"></p>
    </section>

    <!-- ‚ùå Delete Employee -->
    <section>
      <h3>Delete Employee</h3>
      <input type="number" id="searchId" placeholder="Enter Employee ID">
      <button id="searchBtn">Search</button>
      <div id="searchResult"></div>
    </section>

    <!-- üîë Change Password -->
    <section>
      <h3>Change Employee Password</h3>
      <input type="number" id="searchIdPwd" placeholder="Enter Employee ID">
      <button id="searchBtnPwd">Search</button>
      <div id="pwdResult"></div>
    </section>

    <!-- üìä Generate Insights -->
    <section>
      <h3>Data Insights</h3>
      <button onclick="window.location.href='/insights'">Generate Insights</button>
    </section>

    <a href="/logout">Logout</a>
  </div>

  <script>
(async () => {
  // üó∫Ô∏è Initialize map
  let lat = 20, lon = 0;
  try {
    const pos = await new Promise((res, rej) => {
      navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy: true });
    });
    lat = pos.coords.latitude;
    lon = pos.coords.longitude;
  } catch {
    console.warn("Could not get admin location, using default.");
  }

  const map = L.map('map').setView([lat, lon], 14);
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 22 }).addTo(map);

  const customerIcon = L.divIcon({
    className: 'custom-customer-marker',
    html: '<span style="font-size: 30px;">üìç</span>',
    iconSize: [10, 30],
    iconAnchor: [10, 30]
  });

  const res = await fetch('/get_all_markers');
  const markers = await res.json();

  markers.forEach(m => {
    if (m.latitude && m.longitude) {
      L.marker([m.latitude, m.longitude], { icon: customerIcon })
        .addTo(map)
        .bindPopup(`
          <b>üßç‚Äç‚ôÇÔ∏è Employee:</b> ${m.employee_name} (ID: ${m.employee_id})<br>
          <b>üì¶ Customer:</b> ${m.customer_name} (ID: ${m.customer_id})<br>
          <b>üìû Phone:</b> ${m.customer_phone}<br>
          <b>üß¥ Bottles:</b> ${m.bottles}
        `);
    }
  });
})();
const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');


// ‚ûï Add employee
document.getElementById('addEmployeeForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const password = formData.get('password');
  const hashedPassword = CryptoJS.SHA256(password).toString();
  formData.set('password', hashedPassword);
  
  const res = await fetch('/add_employee', { method: 'POST', headers: { 'X-CSRFToken': csrfToken }, body: formData });
  const result = await res.json();
  const msg = document.getElementById('addEmployeeMsg');
  if (result.status === 'success') {
    msg.innerText = `‚úÖ Employee added! ID: ${result.employee_id}`;
    e.target.reset();
  } else msg.innerText = `‚ùå Error: ${result.message}`;
});

// üîç Search Employee (Delete)
document.getElementById('searchBtn').addEventListener('click', async () => {
  const id = document.getElementById('searchId').value.trim();
  const resultDiv = document.getElementById('searchResult');
  resultDiv.innerHTML = '';

  if (!id) {
    resultDiv.innerHTML = '<p style="color:red;">Enter employee ID</p>';
    return;
  }

  const res = await fetch(`/get_employee/${id}`);
  const data = await res.json();

  if (data.status === 'not_found') {
    resultDiv.innerHTML = '<p style="color:red;">Employee not found</p>';
  } else {
    resultDiv.innerHTML =
      `<p><b>Employee ID:</b> ${data.id}<br>
       <b>Name:</b> ${data.name}</p>
       <button id="deleteBtn">Delete Employee</button>`;
    
    document.getElementById('deleteBtn').addEventListener('click', async () => {
      if (!confirm(`Are you sure you want to delete ${data.name}?`)) return;
      const delRes = await fetch(`/delete_employee/${id}`, { method: 'DELETE', headers: { 'X-CSRFToken': csrfToken }});
      const delData = await delRes.json();
      if (delData.status === 'success') {
        resultDiv.innerHTML = `<p style="color:green;">‚úÖ Employee deleted successfully</p>`;
      } else {
        resultDiv.innerHTML = `<p style="color:red;">‚ùå ${delData.message}</p>`;
      }
    });
  }
});

// üîë Change Password Feature
document.getElementById('searchBtnPwd').addEventListener('click', async () => {
  const id = document.getElementById('searchIdPwd').value.trim();
  const pwdDiv = document.getElementById('pwdResult');
  pwdDiv.innerHTML = '';

  if (!id) {
    pwdDiv.innerHTML = '<p style="color:red;">Enter employee ID</p>';
    return;
  }

  const res = await fetch(`/get_employee/${id}`);
  const data = await res.json();

  if (data.status === 'not_found') {
    pwdDiv.innerHTML = '<p style="color:red;">Employee not found</p>';
  } else {
    pwdDiv.innerHTML = `
      <p><b>Employee:</b> ${data.name} (ID: ${data.id})</p>
      <button id="changePwdBtn">Change Password</button>
    `;

    document.getElementById('changePwdBtn').addEventListener('click', () => {
      pwdDiv.innerHTML = `
        <p><b>Employee:</b> ${data.name} (ID: ${data.id})</p>
        <div class="password-wrapper" style="position: relative;margin-top: 10px;">
          <input type="password" id="newPwd" placeholder="Enter New Password" style="width: 100%;padding: 10px 40px 10px 10px;border-radius: 6px;border: 1px solid #ccc;font-size: 1rem;">
          <button type="button" id="togglePassword" style="position: absolute;right: 12px;top: 50%;transform: translateY(-50%);background: none;border: none;cursor: pointer;font-size: 18px;color: #666;padding: 0;line-height: 1;width: 24px;height: 24px;">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-eye" viewBox="0 0 24 24" style="width: 20px;
      height: 20px;
      stroke: currentColor;
      fill: none;
      stroke-width: 2;
      pointer-events: none;">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"/>
            <circle cx="12" cy="12" r="3"/>
          </svg>
        </button>
        </div>
        <button id="savePwdBtn" style="margin-top:10px;padding: 10px 20px;border-radius: 6px;background-color: #007bff;color: white;border:none;cursor:pointer;">Save</button>
      `;
    const passwordInput = document.getElementById("newPwd");
    const toggleButton = document.getElementById("togglePassword");

    const eyeIcon = `
      <svg xmlns="http://www.w3.org/2000/svg" class="icon-eye" viewBox="0 0 24 24" style="width: 20px;
      height: 20px;
      stroke: currentColor;
      fill: none;
      stroke-width: 2;
      pointer-events: none;">
        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"/>
        <circle cx="12" cy="12" r="3"/>
      </svg>`;

    const eyeSlashIcon = `
      <svg xmlns="http://www.w3.org/2000/svg" class="icon-eye-slash" viewBox="0 0 24 24" style="width: 20px;
      height: 20px;
      stroke: currentColor;
      fill: none;
      stroke-width: 2;
      pointer-events: none;">
        <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.1 18.1 0 0 1 4.25-5.94"/>
        <path d="M1 1l22 22"/>
        <path d="M10.58 10.58A3 3 0 0 0 13.42 13.42"/>
        <path d="M9.88 4.12A9.77 9.77 0 0 1 12 4c7 0 11 8 11 8a18.1 18.1 0 0 1-3.17 4.49"/>
      </svg>`;

    toggleButton.addEventListener("click", () => {
      const isHidden = passwordInput.type === "password";
      passwordInput.type = isHidden ? "text" : "password";
      toggleButton.innerHTML = isHidden ? eyeSlashIcon : eyeIcon;
    });

      document.getElementById('savePwdBtn').addEventListener('click', async () => {
        const newPwd = document.getElementById('newPwd').value.trim();
        if (!newPwd) {
          alert('Enter new password');
          return;
        }
        // Hash password before sending
        const hashedPwd = CryptoJS.SHA256(newPwd).toString();

        const res = await fetch(`/change_password/${id}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
          body: JSON.stringify({ new_password: hashedPwd })
        });
        const dataRes = await res.json();
        if (dataRes.status === 'success') {
          pwdDiv.innerHTML = `<p style="color:green;">‚úÖ Password changed successfully</p>`;
        } else {
          pwdDiv.innerHTML = `<p style="color:red;">‚ùå ${dataRes.message}</p>`;
        }
      });
    });
  }
});
  </script>
</body>
</html>